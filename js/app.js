var songs=[{artist:"Elisa Ambrogio",title:"Superstitious",pos:100,videoID:"o3gRyyGZN9A"},{artist:"Steve Gunn",title:"Milly's Garden",pos:99,videoID:"v0OVC4UphqY"},{artist:"Merchandise",title:"Green Lady",pos:98,videoID:"8M6OLS2JBZU"},{artist:"Copeland",title:"Advice to Young Girls [ft. Actress]",pos:97,videoID:"pse2TOVAkT8",smallImage:true},{artist:"DJ Quik",title:"Pet Sematary",pos:96,videoID:"Ub0zVVIVJ2w"},{artist:"Cymbals Eat Guitars",title:"Jackson",pos:95,videoID:"EHSIHm3Zjr8"},{artist:"Taylor Swift",title:"Out of the Woods",pos:94,videoID:"B0JC9x3xnWw",live:true},{artist:"The New Pornographers",title:"War on the East Coast",pos:93,videoID:"WMcumbSMY_8"},{artist:"iLoveMakonnen",title:"I Don't Sell Molly No More",pos:92,videoID:"Ljd7h8ovEow"},{artist:"Hundred Waters",title:"Murmurs",pos:91,videoID:"vo-8Oa2t4Ro"},{artist:"Protomartyr",title:"Scum, Rise!",pos:90,videoID:"YyiGs1afh4o"},{artist:"Cloud Nothings",title:"I'm Not Part of Me",pos:89,videoID:"74TP8QhupLU"},{artist:"Lauryn Hill",title:"Black Rage (Sketch)",pos:88,videoID:"l_sdubWaY5o"},{artist:"Viet Cong",title:"Continental Shelf",pos:87,videoID:"hdMz7BUtOvk"},{artist:"Vince Staples",title:"Blue Suede",pos:86,videoID:"NJLfCBBcZAo"},{artist:"Arca",title:"Thievery",pos:85,videoID:"FdlfbMnNJ_4"},{artist:"Father John Misty",title:"Bored in the USA",pos:84,videoID:"geyRGO04BZ4"},{artist:"Ought",title:"Habit",pos:83,videoID:"gZ9Gkg_tado"},{artist:"Jessica Pratt",title:"Back, Baby",pos:82,videoID:"SNRpptZgWFw",smallImage:true},{artist:"Andy Stott",title:"Faith in Strangers",pos:81,videoID:"9BIYV3BLcno",smallImage:true},{artist:"Shellac",title:"Dude Incredible",pos:80,videoID:"StooJzxAfrc"},{artist:"A Sunny Day in Glasgow",title:"In Love With Useless (The Timeless Geometry In The Tradition Of Passing)",pos:79,videoID:"TUFoj59A8-8"},{artist:"Rustie",title:"Attak [ft. Danny Brown]",pos:78,videoID:"9Bq2Cex0KlU"},{artist:"Rae Sremmurd",title:"No Flex Zone",pos:77,videoID:"UkiHbmreLaQ"},{artist:"Röyksopp / Robyn",title:"Do It Again",pos:76,videoID:"l4CqzNfnlZs"},{artist:"Pharmakon",title:"Bestial Burden",pos:75,videoID:"vPvrM9JuT1o"},{artist:"Holly Herndon",title:"Chorus",pos:74,videoID:"nHujh3yA3BE"},{artist:"Makthaverskan",title:"Asleep",pos:73,videoID:"444DSGx6OlI"},{artist:"Ty Segall",title:"The Singer",pos:72,videoID:"Quou6o05g5A"},{artist:"Parquet Courts",title:"Sunbathing Animal",pos:71,videoID:"mhPOZXLmTKA"},{artist:"Azealia Banks",title:"Chasing Time",pos:70,videoID:"WqAEC4Ydgbo"},{artist:"Rich Gang",title:"Lifestyle",pos:69,videoID:"aaK_cDj6SnE"},{artist:"Grouper",title:"Clearing",pos:68,videoID:"atoXylgyBks"},{artist:"White Lung",title:"Face Down",pos:67,videoID:"BUIaj338JoE"},{artist:"How to Dress Well",title:"Words I Don't Remember",pos:66,videoID:"sbOCLEIKZOo"},{artist:"Iceage",title:"The Lord's Favorite",pos:65,videoID:"roB4hRdLlas"},{artist:"Leon Vynehall",title:"Goodthing",pos:64,videoID:"ZP7oy6O7hrU"},{artist:"Eno/Hyde",title:"Return",pos:63,videoID:"",available:false},{artist:"YG",title:"Left, Right",pos:62,videoID:"a1aZjlpvpS0"},{artist:"Perfume Genius",title:"Fool",pos:61,videoID:"S2Oqi8Ddqw4"},{artist:"Ariel Pink",title:"Picture Me Gone",pos:60,videoID:"YS87mPfD_yI"},{artist:"Alvvays",title:"Archie, Marry Me",pos:59,videoID:"ZAn3JdtSrnY"},{artist:"Against Me!",title:"Transgender Dysphoria Blues",pos:58,videoID:"HEE7iw5WYJI"},{artist:"Dej Loaf",title:"Try Me",pos:57,videoID:"6m1CdtN2Sz4"},{artist:"Migos",title:"Fight Night",pos:56,videoID:"HsVnUpl2IKQ"},{artist:"Kendrick Lamar",title:"i",pos:55,videoID:"8aShfolR6w8"},{artist:"Spoon",title:"Inside Out",pos:54,videoID:"IpT5SBg1Mmk",smallImage:true},{artist:"Perfect Pussy",title:"Interference Fits",pos:53,videoID:"_R4YuekVuNY",smallImage:true},{artist:"Todd Terje",title:"Delorean Dynamite",pos:52,videoID:"LUOIvT9hzD8","smallImage":"true"},{artist:"Owen Pallett",title:"I Am Not Afraid",pos:51,videoID:"7KNDXQUJ9BI",smallImage:true},{artist:"Taylor Swift",title:"Style",pos:50,videoID:"",available:false},{artist:"Run the Jewels",title:"Blockbuster Night Pt. 1",pos:49,videoID:"uuWQyfGa1yI"},{artist:"Lykke Li",title:"Gunshot",pos:48,videoID:"AIruwzhozTc"},{artist:"Nils Frahm",title:"Says",pos:47,videoID:"dIwwjy4slI8"},{artist:"Mr Twin Sister",title:"In the House of Yes",pos:46,videoID:"gmpwRErrrsk"},{artist:"Ariel Pink",title:"Put Your Number in My Phone",pos:45,videoID:"TYoQ6WLuMq4"},{artist:"Angel Olsen",title:"Lights Out",pos:44,videoID:"95rdyhLYOi0"},{artist:"Ariana Grande",title:"Love Me Harder [ft. The Weeknd]",pos:43,videoID:"g5qU7p7yOY8"},{artist:"St. Vincent",title:"Prince Johnny",pos:42,videoID:"idllxjHbX7w",smallImage:true},{artist:"The War on Drugs",title:"An Ocean in Between the Waves",pos:41,videoID:"23GdGEzZPvE"},{artist:"Jessie Ware",title:"Tough Love",pos:40,videoID:"XLaOxbd37jc"},{artist:"Real Estate",title:"Talking Backwards",pos:39,videoID:"MgsdblVq8wo"},{artist:"Bobby Shmurda",title:"Hot Nigga",pos:38,videoID:"vJwKKKd2ZYE",smallImage:true},{artist:"Charli XCX",title:"Boom Clap",pos:37,videoID:"AOPMlIIg_38"},{artist:"Mac DeMarco",title:"Passing Out Pieces",pos:36,videoID:"vF7P3oq8Enc"},{artist:"FKA twigs",title:"Pendulum",pos:35,videoID:"Cw6H9YsTLek"},{artist:"Tobias Jesso Jr.",title:"True Love",pos:34,videoID:"baVveuLnoA4",smallImage:true},{artist:"Ariana Grande",title:"Problem [ft. Iggy Azalea]",pos:33,videoID:"iS1g8G_njx8"},{artist:"Swans",title:"Oxygen",pos:32,videoID:"1jSdTBGhDSg",smallImage:true},{artist:"Aphex Twin",title:"minipops 67 [120.2][source field mix]",pos:31,videoID:"RUAJ8KLGqis"},{artist:"A. G. Cook",title:"Beautiful",pos:30,videoID:"-hmQ2n5FCdM"},{artist:"Spoon",title:"Do You",pos:29,videoID:"fd6aXM8WHGw",smallImage:true},{artist:"Grouper",title:"Holding",pos:28,videoID:"i31zFiwBFho"},{artist:"Sharon Van Etten",title:"Your Love Is Killing Me",pos:27,videoID:"nyuPWHwZru0",smallImage:true},{artist:"Beyoncé",title:"Partition",pos:26,videoID:"pZ12_E5R3qc",smallImage:true},{artist:"Vic Mensa",title:"Down on My Luck",pos:25,videoID:"5jUGAVUwhRU"},{artist:"St. Vincent",title:"Digital Witness",pos:24,videoID:"mVAxUMuhz98"},{artist:"Flying Lotus",title:"Never Catch Me [ft. Kendrick Lamar]",pos:23,videoID:"2lXD0vv-ds8"},{artist:"Ex Hex",title:"Don't Wanna Lose",pos:22,videoID:"2ZVn1UrCvjc",smallImage:true},{artist:"Sophie",title:"Lemonade / “Hard",pos:21,videoID:"LdLvp630plc"},{artist:"Nicki Minaj",title:"Boss Ass Bitch (Remix) [ft. PTAF]",pos:20,videoID:"qg1tO7yQ0dE",smallImage:true},{artist:"Sun Kil Moon",title:"Carissa",pos:19,videoID:"GBNdOTu2Wn0",smallImage:true},{artist:"Panda Bear",title:"Mr Noah",pos:18,videoID:"CmXIIL2tmR8"},{artist:"Tinashe",title:"2 On [ft. Schoolboy Q]",pos:17,videoID:"s7TCuCpB5c",smallImage:true},{artist:"Young Thug",title:"Stoner",pos:16,videoID:"Vs_ESC5gc5w",smallImage:true},{artist:"Lil B",title:"No Black Person Is Ugly",pos:15,videoID:"83p69JhDnwU"},{artist:"QT",title:"Hey QT",pos:14,videoID:"z6_ikWlJu_0"},{artist:"Todd Terje",title:"Johnny and Mary [ft. Bryan Ferry] (Robert Palmer cover)",pos:13,videoID:"EFSGe-l18Yo",smallImage:true},{artist:"Drake",title:"0 to 100 / The Catch Up",pos:12,videoID:"ziYLeF5f8nk",smallImage:true},{artist:"Shamir",title:"On the Regular",pos:11,videoID:"Lp9GgdCgMXk"},{artist:"Michael Jackson",title:"Love Never Felt So Good (Original Version)",pos:10,videoID:"fw-iK0Nztv0"},{artist:"Future",title:"Move That Dope [ft. Pharrell, Pusha T, and Casino]",pos:9,videoID:"wHguy4xHGSg",smallImage:true},{artist:"Perfume Genius",title:"Queen",pos:8,videoID:"Z7OSSUwPVM4"},{artist:"Beyoncé",title:"***Flawless [ft. Chimamanda Ngozi Adichie]",pos:7,videoID:"IyuUWOnS9BY"},{artist:"Run the Jewels",title:"Close Your Eyes (And Count to Fuck) [ft. Zack De La Rocha]",pos:6,videoID:"rghRRD4mCn4",smallImage:true},{artist:"The War on Drugs",title:"Red Eyes",pos:5,videoID:"1LmX5c7HoUw"},{artist:"Caribou",title:"Can't Do Without You",pos:4,videoID:"BI2Et19vDCM"},{artist:"FKA twigs",title:"Two Weeks",pos:3,videoID:"3yDP9MKVhZc"},{artist:"iLoveMakonnen",title:"Club Goin Up on a Tuesday [ft. Drake]",pos:2,videoID:"avFq9errZCk"},{artist:"Future Islands",title:"Seasons (Waiting on You)",pos:1,videoID:"-5Ae-LhMIG0"}];
var SELECTOR = null;
var listElement = null;
var firstVideoID = '';
var videoID = '';
var currentVideo = 0;
var nextVideo = null;
var player;
var videoLoading = false;
var errorTimeout;
var imageList = [];
var isPlaying = false;
var is_mobile = (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent));

function init() {
  setupSelectors();
  getData();
  eventListeners();
  if (localStorage.getItem('currentVideo') === null) {
    getFirstVideo();
  } else {
    getLocalStorage();
  }
  loadApi();
}

function setupSelectors() {
  SELECTOR = $('.pitchfork');
  listElement = SELECTOR.find('.songs');
}

function eventListeners() {
  SELECTOR.find('.song').on('click', function(e) { onItemClicked(e); });
  SELECTOR.find('.next-track').on('click', function(e) { onNextClicked(e); });
  SELECTOR.find('.prev-track').on('click', function(e) { onPrevClicked(e); });
  SELECTOR.find('.info-button').on('click', function(e) { onTrackInfoClicked(e); });
  $(document).on("keyup", function (e) { onKeyPressed(e); });
}

function onKeyPressed (e) {
  var key = e.keyCode;
  if (key === 39) {
    findNextVideo();
  } else if (key === 37) {
    findPrevVideo();
  } else if (key === 32 || e.which === 32) {
    if (isPlaying) {
      pauseVideo();
    } else {
      playVideo();
    }
    e.preventDefault();
  }
}

function getData() {
  $(songs).each(function(i) {
    var song = $(this)[0],
        title = song.title,
        artist = song.artist,
        pos = song.pos,
        vid = song.videoID,
        poster = 'http://img.youtube.com/vi/'+vid+'/maxresdefault.jpg';

    if (song.smallImage) {
      poster = 'http://img.youtube.com/vi/'+vid+'/default.jpg';
    }

    imageList.push(poster);

    listElement.append('<li class="song" data-vid="'+vid+'" data-title="'+title+'" data-artist="'+artist+'" data-poster="'+poster+'"><div class="song-overlay"></div><div class="duration"></div><div class="title"><p>'+pos+'. '+title+'</p></div><div class="artist"><p>'+artist+'</p></div><div class="controls"><a class="play-pause"></a><a class="loader"></a><a class="pause"></a><a class="button mobile-button" target="_blank" href="https://www.youtube.com/watch?v='+vid+'">Watch Video</a></div></li>');

    if (song.available === false) {
      SELECTOR.find('.song').eq(i).addClass('na');
    }

    if (song.live) {
      SELECTOR.find('.song').eq(i).addClass('live-video');
    }
  });

  preloadImages(imageList);
}

function preloadImages(images) {
  if (!is_mobile) {
    for (var i = 0; i < images.length; i++ ) {
      var imageObject = new Image();
      imageObject.src = imageList[i];
    }
  }
}

function getFirstVideo() {
  firstVideoID = $(songs)[0].videoID;
}

function getLocalStorage() {
  var getItem = localStorage.getItem('currentVideo');
  firstVideoID = SELECTOR.find('.song').eq(getItem).data('vid');
}

function loadApi() {
  if (!is_mobile) {
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    onYouTubeIframeAPIReady();
  } else {
    SELECTOR.addClass('mobile-device');
  }
}

function onYouTubeIframeAPIReady() {
  player = new YT.Player('player', {
    height: '200',
    width: '400',
    videoId: firstVideoID,
    events: {
      'onReady': onPlayerReady,
      'onStateChange': onPlayerStateChange
    }
  });
}

function onPlayerReady(event) {
  if (localStorage.getItem('currentVideo') === null) {
    currentVideo = 0;
    
  } else {
    currentVideo = localStorage.getItem('currentVideo');
  }
  setCurrentVideo();
  setBackgroundImage();
  setTimeout(function(){
    goToVideo();
  }, 400);
  event.target.playVideo();
}

function onPlayerStateChange(event) {
  // If video complete, find next video automatically
  if (event.data === 0) {
    findNextVideo();
  }
  // If video playing, add playing class and set loading var to false
  if (event.data === 1) {
    SELECTOR.find('.song').eq(currentVideo).addClass('playing');
    videoLoading = false;
    clearInterval(errorTimeout);
    closeError();
    isPlaying = true;
  } else {
    // Otherwise, remove playing class
    SELECTOR.find('.song').eq(currentVideo).removeClass('playing');
  }
  // If buffering, show loader
  if (event.data === -1 || event.data === 3) {
    SELECTOR.find('.song').eq(currentVideo).addClass('buffering');
  } else {
    // Remove buffering class from all songs when done
    SELECTOR.find('.song').removeClass('buffering');
  }
  // If unstarted, after 5 secs, show error, move on
  if (event.data === -1) {
    errorTimeout = setTimeout(function() {
      errorMessage();
    }, 7500);
  }
}

function errorMessage() {
  clearInterval(errorTimeout);
  showError('Error with video, starting the next one for you...');
  setTimeout(function() {
    videoLoading = false;
    findNextVideo();
  }, 1000);
}

function showError(message) {
  SELECTOR.find('.error-message').addClass('active');
  SELECTOR.find('.error-message .inner').html(message);
}

function closeError() {
  SELECTOR.find('.error-message .inner').empty();
  SELECTOR.find('.error-message').removeClass('active');
}

function onItemClicked(e) {
  if (!is_mobile) {
    var elClicked = $(e.currentTarget),
        vid = elClicked.data('vid');

    if (currentVideo == elClicked.index()) {
      // If playing, pause it.
      if (player.getPlayerState() === 1) {
        pauseVideo();
      // If paused, play it.
      } else if (player.getPlayerState() === 2) {
        playVideo();
      }
    // If clicked on another video completely
    } else {
      currentVideo = elClicked.index();
      loadVideo(vid);
    }
  }
}

function onNextClicked(e) {
  if (currentVideo !== 99) {
    findNextVideo();
  }
}

function onPrevClicked(e) {
  if (currentVideo !== 0) {
    findPrevVideo();
  }
}

function findNextVideo() {
  if (!videoLoading) {
    closeInfo();
    currentVideo++;
    // If end of playlist, repeat
    if (currentVideo === 100) {
      currentVideo = 0;
    }
    nextVideo = SELECTOR.find('.song').eq(currentVideo).data('vid');
    loadVideo(nextVideo);
  }
}

function findPrevVideo() {
  if (!videoLoading) {
    currentVideo--;
    prevVideo = SELECTOR.find('.song').eq(currentVideo).data('vid');
    loadVideo(prevVideo);
  }
}

function goToVideo() {
  $('html, body').animate({ scrollTop: SELECTOR.find('.song').eq(currentVideo).offset().top }, 200);
}

function onTrackInfoClicked(e) {
  var elClicked = $(e.currentTarget),
      video = SELECTOR.find('.song').eq(currentVideo),
      videoID = video.data('vid'),
      poster = video.data('poster'),
      title = video.data('title'),
      artist = video.data('artist'),
      artistPlus = artist + ' music',
      artistSearch = artistPlus.split(' ').join('+');

  SELECTOR.find('.track-info').addClass('active');
  if (!SELECTOR.find('.song').eq(currentVideo).hasClass('small-image')) {
    SELECTOR.find('.track-info .background').css({
      backgroundImage: 'url('+imageList[currentVideo]+')'
    });
  } else {
    SELECTOR.find('.track-info .background').css({
      backgroundColor: 'rgba(0,0,255,0.85)'
    });
  }

  SELECTOR.find('.track-info .inner').append(
    '<h1>'+title+'</h1><h2>'+artist+'</h2><a class="button search-artist" target="_blank" href="https://www.google.co.uk/#q='+artistSearch+'">Search Artist</a><a class="button watch-video" target="_blank" href="https://www.youtube.com/watch?v='+videoID+'">Watch Video</a>'
  )

  bodyOverflow();
  newListeners();
}

function bodyOverflow() {
  SELECTOR.toggleClass('no-scroll');
}

function newListeners() {
  SELECTOR.find('.watch-video').on('click', function() { onWatchClicked() });
  SELECTOR.find('.close').on('click', function() { onCloseClicked() });
  SELECTOR.find('.search-artist').hover(function() { onSearchHover() }, function (){ offSearchHover() });
}

function onSearchHover() {
  SELECTOR.find('.inner h2').addClass('active');
}

function offSearchHover() {
  SELECTOR.find('.inner h2').removeClass('active');
}

function onCloseClicked() {
  closeInfo();
}

function onWatchClicked() {
  pauseVideo();
}

function loadVideo(id) {
  if (SELECTOR.find('.song').eq(currentVideo).hasClass('na')) {
    findNextVideo();
  } else {
    if (!videoLoading) {
      SELECTOR.removeClass('live');
      if (SELECTOR.find('.song').eq(currentVideo).hasClass('live-video')) {
        SELECTOR.addClass('live');
      }
      videoLoading = true;
      setCurrentVideo();
      player.loadVideoById(id);
      infoHint();
      goToVideo();
      setLocalStorage();
      setBackgroundImage();
    }
  }
}

function setLocalStorage() {
  localStorage.setItem('currentVideo', currentVideo);
}

function setCurrentVideo() {
  SELECTOR.find('.song').removeClass('active playing');
  SELECTOR.find('.song').eq(currentVideo).addClass('active');
}

function infoHint() {
  SELECTOR.find('.info-button').addClass('hint');
  setTimeout(function() {
    SELECTOR.find('.info-button').removeClass('hint');
  }, 200);
}

function setBackgroundImage() {
  var videoElement = SELECTOR.find('.song').eq(currentVideo);
  SELECTOR.find('.song').css('background-image', 'none');
  videoElement.css({
    backgroundImage: 'url('+imageList[currentVideo]+')',
    backgroundPosition: 'center center',
    backgroundSize: 'cover',
    backgroundRepeat: 'no-repeat'
  })
}

function closeInfo() {
  SELECTOR.find('.track-info').removeClass('active');
  SELECTOR.find('.track-info .inner').empty();
  bodyOverflow();
}

function pauseVideo() {
  player.pauseVideo();
  isPlaying = false;
}

function playVideo() {
  player.playVideo();
}

$(function() {
  init();
});